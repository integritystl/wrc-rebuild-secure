<?php

// Include WordPress
define('WP_USE_THEMES', false);
require('wp-load.php');

$file_path = '/Users/aaronrowe/Desktop/test.json';

$db_user = 'root';
$db_pass = 'root';
$db_name = 'wrc_secure_test';
$db_host = 'localhost';
$dbi = new wpdb($db_user, $db_pass, $db_name, $db_host);


$agency_query = "select ID, post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt, post_status, comment_status, ping_status, post_password, post_name, to_ping, pinged, post_modified, post_modified_gmt, post_content_filtered, post_parent, guid, menu_order, post_type, post_mime_type, comment_count, pm.meta_value as  meta_code, pm1.meta_value as  meta_address, pm2.meta_value as  meta_city, pm3.meta_value as  meta_state, pm4.meta_value as  meta_zip, pm5.meta_value as  meta_phone, pm6.meta_value as  meta_website, pm7.meta_value as  meta_underwriter from wp_posts as p left join wp_postmeta as pm on p.id = pm.post_id and pm.meta_key = 'code' left join wp_postmeta as pm1 on p.id = pm1.post_id and pm1.meta_key = 'address' left join wp_postmeta as pm2 on p.id = pm2.post_id and pm2.meta_key = 'city' left join wp_postmeta as pm3 on p.id = pm3.post_id and pm3.meta_key = 'state' left join wp_postmeta as pm4 on p.id = pm4.post_id and pm4.meta_key = 'zip' left join wp_postmeta as pm5 on p.id = pm5.post_id and pm5.meta_key = 'phone' left join wp_postmeta as pm6 on p.id = pm6.post_id and pm6.meta_key = 'website' left join wp_postmeta as pm7 on p.id = pm7.post_id and pm7.meta_key = 'underwriter' where post_type = 'agencies' and (post_status = 'publish' or post_status = 'private') group by ID;";
$agency_data = $dbi->get_results($agency_query);

$mutuals_query = "select p.id as ID, post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt, post_status, comment_status, ping_status, post_password, post_name, to_ping, pinged, post_modified, post_modified_gmt, post_content_filtered, post_parent, guid, menu_order, post_type, post_mime_type, comment_count, pm.meta_value as  meta_code, pm1.meta_value as  meta_address, pm2.meta_value as  meta_city, pm3.meta_value as  meta_state, pm4.meta_value as  meta_zip, pm5.meta_value as  meta_phone, pm6.meta_value as  meta_website, pm7.meta_value as  meta_manager_name, pm8.meta_value as  meta_manager_email, pm9.meta_value as meta_agencies_0_agency, pm10.meta_value as meta_agencies_1_agency, pm11.meta_value as meta_agencies_2_agency, pm12.meta_value as meta_agencies_3_agency, pm13.meta_value as meta_agencies_4_agency, pm14.meta_value as meta_agencies_5_agency, pm15.meta_value as meta_agencies_6_agency, pm16.meta_value as meta_agencies_7_agency, pm17.meta_value as meta_agencies_8_agency, pm18.meta_value as meta_agencies_9_agency, pm19.meta_value as meta_agencies_10_agency, pm20.meta_value as meta_agencies_11_agency, pm21.meta_value as meta_agencies_12_agency, pm22.meta_value as meta_agencies_13_agency, pm23.meta_value as meta_agencies_14_agency, pm24.meta_value as meta_agencies_15_agency, pm25.meta_value as meta_agencies_16_agency, pm26.meta_value as meta_agencies_17_agency, pm27.meta_value as meta_agencies_18_agency, pm28.meta_value as meta_agencies_19_agency, pm29.meta_value as meta_agencies_20_agency, pm30.meta_value as meta_agencies_21_agency, pm31.meta_value as meta_agencies_22_agency, pm32.meta_value as meta_agencies_23_agency, pm33.meta_value as meta_agencies_24_agency, pm34.meta_value as meta_agencies_25_agency, pm35.meta_value as meta_agencies_26_agency, pm36.meta_value as meta_agencies_27_agency, pm37.meta_value as meta_agencies_28_agency, pm38.meta_value as meta_agencies_29_agency, a.agencies as meta_agencies from wp_posts as p left join wp_postmeta as pm on p.id = pm.post_id and pm.meta_key = 'code' left join wp_postmeta as pm1 on p.id = pm1.post_id and pm1.meta_key = 'address' left join wp_postmeta as pm2 on p.id = pm2.post_id and pm2.meta_key = 'city' left join wp_postmeta as pm3 on p.id = pm3.post_id and pm3.meta_key = 'state' left join wp_postmeta as pm4 on p.id = pm4.post_id and pm4.meta_key = 'zip' left join wp_postmeta as pm5 on p.id = pm5.post_id and pm5.meta_key = 'phone' left join wp_postmeta as pm6 on p.id = pm6.post_id and pm6.meta_key = 'website' left join wp_postmeta as pm7 on p.id = pm7.post_id and pm7.meta_key = 'manager_name' left join wp_postmeta as pm8 on p.id = pm8.post_id and pm8.meta_key = 'manager_email' left join wp_postmeta as pm9 on p.id = pm9.post_id and pm9.meta_key = 'agencies_0_agency' left join wp_postmeta as pm10 on p.id = pm10.post_id and pm10.meta_key = 'agencies_1_agency' left join wp_postmeta as pm11 on p.id = pm11.post_id and pm11.meta_key = 'agencies_2_agency' left join wp_postmeta as pm12 on p.id = pm12.post_id and pm12.meta_key = 'agencies_3_agency' left join wp_postmeta as pm13 on p.id = pm13.post_id and pm13.meta_key = 'agencies_4_agency' left join wp_postmeta as pm14 on p.id = pm14.post_id and pm14.meta_key = 'agencies_5_agency' left join wp_postmeta as pm15 on p.id = pm15.post_id and pm15.meta_key = 'agencies_6_agency' left join wp_postmeta as pm16 on p.id = pm16.post_id and pm16.meta_key = 'agencies_7_agency' left join wp_postmeta as pm17 on p.id = pm17.post_id and pm17.meta_key = 'agencies_8_agency' left join wp_postmeta as pm18 on p.id = pm18.post_id and pm18.meta_key = 'agencies_9_agency' left join wp_postmeta as pm19 on p.id = pm19.post_id and pm19.meta_key = 'agencies_10_agency' left join wp_postmeta as pm20 on p.id = pm20.post_id and pm20.meta_key = 'agencies_11_agency' left join wp_postmeta as pm21 on p.id = pm21.post_id and pm21.meta_key = 'agencies_12_agency' left join wp_postmeta as pm22 on p.id = pm22.post_id and pm22.meta_key = 'agencies_13_agency' left join wp_postmeta as pm23 on p.id = pm23.post_id and pm23.meta_key = 'agencies_14_agency' left join wp_postmeta as pm24 on p.id = pm24.post_id and pm24.meta_key = 'agencies_15_agency' left join wp_postmeta as pm25 on p.id = pm25.post_id and pm25.meta_key = 'agencies_16_agency' left join wp_postmeta as pm26 on p.id = pm26.post_id and pm26.meta_key = 'agencies_17_agency' left join wp_postmeta as pm27 on p.id = pm27.post_id and pm27.meta_key = 'agencies_18_agency' left join wp_postmeta as pm28 on p.id = pm28.post_id and pm28.meta_key = 'agencies_19_agency' left join wp_postmeta as pm29 on p.id = pm29.post_id and pm29.meta_key = 'agencies_20_agency' left join wp_postmeta as pm30 on p.id = pm30.post_id and pm30.meta_key = 'agencies_21_agency' left join wp_postmeta as pm31 on p.id = pm31.post_id and pm31.meta_key = 'agencies_22_agency' left join wp_postmeta as pm32 on p.id = pm32.post_id and pm32.meta_key = 'agencies_23_agency' left join wp_postmeta as pm33 on p.id = pm33.post_id and pm33.meta_key = 'agencies_24_agency' left join wp_postmeta as pm34 on p.id = pm34.post_id and pm34.meta_key = 'agencies_25_agency' left join wp_postmeta as pm35 on p.id = pm35.post_id and pm35.meta_key = 'agencies_26_agency' left join wp_postmeta as pm36 on p.id = pm36.post_id and pm36.meta_key = 'agencies_27_agency' left join wp_postmeta as pm37 on p.id = pm37.post_id and pm37.meta_key = 'agencies_28_agency' left join wp_postmeta as pm38 on p.id = pm38.post_id and pm38.meta_key = 'agencies_29_agency'
left join (select p.id as id, count(*) as agencies from wp_posts as p join wp_postmeta as pm on p.id = pm.post_id where p.post_type = 'client_companies' and pm.meta_key like 'agencies_%' group by p.id) as a on p.id = a.id
 where post_type = 'client_companies' and (post_status = 'publish' or post_status = 'private') group by ID;";
$mutuals_data = $dbi->get_results($mutuals_query);

$users_query = "select ID, user_login, user_pass, user_nicename, user_email, user_url, user_registered, user_activation_key, user_status, display_name, um0.meta_value as meta_address, um1.meta_value as meta_admin_color, um2.meta_value as meta_agency, um3.meta_value as meta_agree_with_terms_and_conditions, um4.meta_value as meta_approved, um5.meta_value as meta_ca, um6.meta_value as meta_city, um7.meta_value as meta_comment_shortcuts, um8.meta_value as meta_company, um9.meta_value as meta_description, um10.meta_value as meta_first_name, um11.meta_value as meta_ft, um12.meta_value as meta_last_change_password_date, um13.meta_value as meta_last_name, um14.meta_value as meta_last_password_reset, um15.meta_value as meta_li, um16.meta_value as meta_login_attempt_count, um17.meta_value as `meta_mutual-client`, um18.meta_value as meta_nickname, um19.meta_value as meta_old_passwords, um20.meta_value as meta_other_permissions, um21.meta_value as meta_pa, um22.meta_value as meta_password_reset_count, um23.meta_value as meta_phone, um24.meta_value as meta_rich_editing, um25.meta_value as meta_show_admin_bar_front, um26.meta_value as meta_sites, um27.meta_value as meta_states, um28.meta_value as meta_um, um29.meta_value as meta_use_ssl, um30.meta_value as meta_wp_capabilities, um31.meta_value as meta_wp_user_level, um32.meta_value as meta_zip, um33.meta_value as meta_default_password_nag, um34.meta_value as meta_locale, um35.meta_value as meta_password_reset_times, um37.meta_value as meta_wp_user_settings, um38.meta_value as meta_wp_user_settings_time, um39.meta_value as meta_initials, um40.meta_value as meta_state from wp_users as u left join wp_usermeta as um0 on um0.user_id = u.id and um0.meta_key = 'address' left join wp_usermeta as um1 on um1.user_id = u.id and um1.meta_key = 'admin_color' left join wp_usermeta as um2 on um2.user_id = u.id and um2.meta_key = 'agency' left join wp_usermeta as um3 on um3.user_id = u.id and um3.meta_key = 'agree_with_terms_and_conditions' left join wp_usermeta as um4 on um4.user_id = u.id and um4.meta_key = 'approved' left join wp_usermeta as um5 on um5.user_id = u.id and um5.meta_key = 'ca' left join wp_usermeta as um6 on um6.user_id = u.id and um6.meta_key = 'city' left join wp_usermeta as um7 on um7.user_id = u.id and um7.meta_key = 'comment_shortcuts' left join wp_usermeta as um8 on um8.user_id = u.id and um8.meta_key = 'company' left join wp_usermeta as um9 on um9.user_id = u.id and um9.meta_key = 'description' left join wp_usermeta as um10 on um10.user_id = u.id and um10.meta_key = 'first_name' left join wp_usermeta as um11 on um11.user_id = u.id and um11.meta_key = 'ft' left join wp_usermeta as um12 on um12.user_id = u.id and um12.meta_key = 'last_change_password_date' left join wp_usermeta as um13 on um13.user_id = u.id and um13.meta_key = 'last_name' left join wp_usermeta as um14 on um14.user_id = u.id and um14.meta_key = 'last_password_reset' left join wp_usermeta as um15 on um15.user_id = u.id and um15.meta_key = 'li' left join wp_usermeta as um16 on um16.user_id = u.id and um16.meta_key = 'login_attempt_count' left join wp_usermeta as um17 on um17.user_id = u.id and um17.meta_key = 'mutual' left join wp_usermeta as um18 on um18.user_id = u.id and um18.meta_key = 'nickname' left join wp_usermeta as um19 on um19.user_id = u.id and um19.meta_key = 'old_passwords' left join wp_usermeta as um20 on um20.user_id = u.id and um20.meta_key = 'other_permissions' left join wp_usermeta as um21 on um21.user_id = u.id and um21.meta_key = 'pa' left join wp_usermeta as um22 on um22.user_id = u.id and um22.meta_key = 'password_reset_count' left join wp_usermeta as um23 on um23.user_id = u.id and um23.meta_key = 'phone' left join wp_usermeta as um24 on um24.user_id = u.id and um24.meta_key = 'rich_editing' left join wp_usermeta as um25 on um25.user_id = u.id and um25.meta_key = 'show_admin_bar_front' left join wp_usermeta as um26 on um26.user_id = u.id and um26.meta_key = 'sites' left join wp_usermeta as um27 on um27.user_id = u.id and um27.meta_key = 'states' left join wp_usermeta as um28 on um28.user_id = u.id and um28.meta_key = 'um' left join wp_usermeta as um29 on um29.user_id = u.id and um29.meta_key = 'use_ssl' left join wp_usermeta as um30 on um30.user_id = u.id and um30.meta_key = 'wp_capabilities' left join wp_usermeta as um31 on um31.user_id = u.id and um31.meta_key = 'wp_user_level' left join wp_usermeta as um32 on um32.user_id = u.id and um32.meta_key = 'zip' left join wp_usermeta as um33 on um33.user_id = u.id and um33.meta_key = 'default_password_nag' left join wp_usermeta as um34 on um34.user_id = u.id and um34.meta_key = 'locale' left join wp_usermeta as um35 on um35.user_id = u.id and um35.meta_key = 'password_reset_times' left join wp_usermeta as um37 on um37.user_id = u.id and um37.meta_key = 'wp_user-settings' left join wp_usermeta as um38 on um38.user_id = u.id and um38.meta_key = 'wp_user-settings-time' left join wp_usermeta as um39 on um39.user_id = u.id and um39.meta_key = 'initials' left join wp_usermeta as um40 on um40.user_id = u.id and um40.meta_key = 'state' group by u.ID";
$users_data = $dbi->get_results($users_query);

$json_array = array();
$json_array['agencies'] = $agency_data;
$json_array['mutuals'] = $mutuals_data;
$json_array['users'] = $users_data;


var_dump(count($agency_data));
var_dump(count($mutuals_data));
var_dump(count($users_data));

$export_json = json_encode($json_array);

$fp = fopen($file_path,"w");
fwrite($fp,$export_json);
fclose($fp);



?>